<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="big head,306647809@qq.com"><title>centos7_kvm · big head</title><meta name="description" content="安装KVM环境123456789101112131415161718192021222324252627282930# 1、检测是否支持KVM[root@localhost ~]# cat /proc/cpuinfo | egrep &quot;vmx|svm&quot;# 2、关闭SELinux[root@local"><meta name="keywords" content="Hexo,HTML,CSS,android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">big head</a></h3><div class="description"><p>随便写写</p></div></div></div><ul class="social-links"><li><a href="http://weibo.com/inoroorg"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/skyisfuck"><i class="fa fa-github"></i></a></li></ul><!--.footer--><!--  a(target="_blank", href="/")--><!--    span Theme by --><!--  a(href="skyisfuck.github.io")  skyisfuck--><!--  span &--><!--  a(href="https://github.com/Ben02/hexo-theme-Anatole")  Ben--><!--  .by_farbox--><!--    a(href="skyisfuck", target="_blank") Proudly published with Hexo&#65281;--><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><center><div class="powered-by"><i class="fa fa-user"></i><span id="busuanzi_container_site_uv">&nbsp; <span id="busuanzi_value_site_uv"></span>&nbsp;  &nbsp;   </span><i class="fa fa-eye"></i><span id="busuanzi_container_site_pv">&nbsp; <span id="busuanzi_value_site_pv"></span></span></div></center></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li><li><a href="/games">小游戏</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>centos7_kvm</a></h3></div><div class="post-content"><h4 id="安装KVM环境"><a href="#安装KVM环境" class="headerlink" title="安装KVM环境"></a>安装KVM环境</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1、检测是否支持KVM</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cat /proc/cpuinfo | egrep "vmx|svm"</span></span><br><span class="line"><span class="comment"># 2、关闭SELinux</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="comment"># 3、安装kvm 管理工具</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum -y install qemu-kvm libvirt virt-install virt-manager virt-viewer</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># qemu-kvm: KVM模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># virt-install: 包含工具（virt-install，virt-clone和virt-image），</span></span><br><span class="line"><span class="comment"># 用于安装和克隆虚拟机使用libvirt。 它完全支持paravirtulized半虚拟化和全虚拟化。 </span></span><br><span class="line"><span class="comment"># 支持的虚拟机管理程序是Xen，qemu（QEMU）和kvm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libvirt: 虚拟管理模块</span></span><br><span class="line"><span class="comment"># virt-manager: 图形界面管理虚拟机</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4、重启宿主机，以便加载 kvm 模块</span></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line">[root@localhost ~]<span class="comment"># reboot</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5、查看KVM模块是否被正确加载</span></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line">[root@localhost ~]<span class="comment"># lsmod | grep kvm</span></span><br><span class="line"></span><br><span class="line">kvm_intel             162153  0</span><br><span class="line">kvm                   525259  1 kvm_intel</span><br><span class="line"><span class="comment"># 6、开启libvirtd服务，并且设置其开机自动启动</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl start libvirtd.service</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl enable libvirtd.service</span></span><br></pre></td></tr></table></figure>
<h4 id="安装虚拟机"><a href="#安装虚拟机" class="headerlink" title="安装虚拟机"></a>安装虚拟机</h4><p>安装前要设置环境语言为英文LANG=”en_US.UTF-8”，如果是中文的话某些版本可能会报错。CentOS 7 在这里修改 /etc/locale.conf。<br>kvm创建虚拟机，特别注意.iso镜像文件一定放到/home 或者根目录重新创建目录，不然会因为权限报错，无法创建虚拟机。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 字符界面安装</span></span><br><span class="line">virt-install \</span><br><span class="line">--virt-type=kvm \</span><br><span class="line">--name=centos78 \</span><br><span class="line">--vcpus=2 \</span><br><span class="line">--memory=4096 \</span><br><span class="line">--location=/tmp/CentOS-7-x86_64-Minimal-1511.iso \</span><br><span class="line">--disk path=/home/vms/centos78.qcow2,size=40,format=qcow2 \</span><br><span class="line">--network bridge=br0 \</span><br><span class="line">--graphics none \</span><br><span class="line">--extra-args=<span class="string">'console=ttyS0'</span> \</span><br><span class="line">--force</span><br><span class="line"></span><br><span class="line"><span class="comment"># --location 里面可以是本地，也可以是nfs，http</span></span><br><span class="line"><span class="comment"># 如 --location=http://mirrors.aliyun.com/centos/7/os/x86_64/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 图形化 vnc 安装</span></span><br><span class="line">virt-install \</span><br><span class="line">--virt-type=kvm \</span><br><span class="line">-n centos7 \</span><br><span class="line">--vcpu 2 \</span><br><span class="line">-r 2048 \</span><br><span class="line">--disk /kvm/disk/centos.qcow2,format=qcow2,size=10 \</span><br><span class="line">--network bridge=br0 \</span><br><span class="line">--cdrom /opt/centos.iso \</span><br><span class="line">--vnc --vncport=5910 --vnclisten=0.0.0.0</span><br></pre></td></tr></table></figure></p>
<h4 id="连接虚拟机"><a href="#连接虚拟机" class="headerlink" title="连接虚拟机"></a>连接虚拟机</h4><p>通过 virsh console &lt;虚拟机名称&gt; 命令来连接虚拟机<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看虚拟机</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh list              # 查看在运行的虚拟机</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh list –all         # 查看所有虚拟机</span></span><br><span class="line"></span><br><span class="line"> Id    Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line"> 7     centos7                        running</span><br><span class="line"></span><br><span class="line"><span class="comment">#连接虚拟机</span></span><br><span class="line">virsh console centos7</span><br></pre></td></tr></table></figure></p>
<h4 id="配置宿主机网络"><a href="#配置宿主机网络" class="headerlink" title="配置宿主机网络"></a>配置宿主机网络</h4><p>1.KVM 虚拟机是基于 NAT 的网络配置；<br>2.只有同一宿主机的虚拟键之间可以互相访问，跨宿主机是不能访问；<br>3.虚拟机需要和宿主机配置成桥接模式，以便虚拟机可以在局域网内可见；</p>
<h6 id="Bridge模式配置"><a href="#Bridge模式配置" class="headerlink" title="Bridge模式配置"></a>Bridge模式配置</h6><p>Bridge方式即虚拟网桥的网络连接方式，是客户机和子网里面的机器能够互相通信。可以使虚拟机成为网络中具有独立IP的主机。桥接网络（也叫 物理设备共享）被用作把一个物理设备复制到一台虚拟机。网桥多用作高级设置，特别是主机多个网络接口的情况。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────┐      ┌─────────────────┐</span><br><span class="line">│          HOST           │      │Virtual Machine 1│</span><br><span class="line">│ ┌──────┐      ┌───────┐ │      │    ┌──────┐     │</span><br><span class="line">│ │ br0  │──┬───│ vnet0 │─│─ ─ ─ │    │ br0  │     │</span><br><span class="line">│ └──────┘  │   └───────┘ │      │    └──────┘     │</span><br><span class="line">│     │     │             │      └─────────────────┘</span><br><span class="line">│     │     │   ┌───────┐ │      ┌─────────────────┐</span><br><span class="line">│ ┌──────┐  └───│ vnet1 │─│─     │Virtual Machine 2│</span><br><span class="line">│ │ eno0 │      └───────┘ │ │    │    ┌──────┐     │</span><br><span class="line">│ └──────┘                │  ─ ─ │    │ br0  │     │</span><br><span class="line">│ ┌──────┐                │      │    └──────┘     │</span><br><span class="line">│ │ eno1 │                │      └─────────────────┘</span><br><span class="line">│ └──────┘                │</span><br><span class="line">└─────────────────────────┘</span><br><span class="line"></span><br><span class="line"># 新建网桥设备</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# cd /etc/sysconfig/network-scripts/</span><br><span class="line">[root@localhost ~]# cp ifcfg-eth0 ifcfg-br0 </span><br><span class="line"></span><br><span class="line">vi ifcfg-eth0</span><br><span class="line">	TYPE=Ethernet</span><br><span class="line">	BOOTPROTO=none</span><br><span class="line">	NAME=eth0</span><br><span class="line">	DEVICE=eth0</span><br><span class="line">	ONBOOT=yes</span><br><span class="line">	BRIDGE=br0</span><br><span class="line">	#IPADDR=192.168.5.137</span><br><span class="line">	#PREFIX=24</span><br><span class="line">	#GATEWAY=192.168.5.2</span><br><span class="line">	#DNS1=192.168.5.2</span><br><span class="line"></span><br><span class="line">vi ifcfg-br0</span><br><span class="line">	TYPE=Bridge</span><br><span class="line">	BOOTPROTO=none</span><br><span class="line">	NAME=br0</span><br><span class="line">	DEVICE=br0</span><br><span class="line">	ONBOOT=yes</span><br><span class="line">	IPADDR=192.168.5.137</span><br><span class="line">	PREFIX=24</span><br><span class="line">	GATEWAY=192.168.5.2</span><br><span class="line">	DNS1=192.168.5.2</span><br><span class="line">	STP=yes</span><br><span class="line"></span><br><span class="line">systemctl restart network</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# brctl show </span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">br0		8000.000c29db5f75	yes		eth0</span><br></pre></td></tr></table></figure></p>
<h6 id="NAT模式"><a href="#NAT模式" class="headerlink" title="NAT模式"></a>NAT模式</h6><p>NAT(Network Address Translation网络地址翻译)，NAT方式是kvm安装后的默认方式。它支持主机与虚拟机的互访，同时也支持虚拟机访问互联网，但不支持外界访问虚拟机。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># virsh net-list --all</span></span><br><span class="line"></span><br><span class="line"> Name                 State      Autostart     Persistent</span><br><span class="line">----------------------------------------------------------</span><br><span class="line"> default              active     no            no</span><br><span class="line"><span class="comment"># default是宿主机安装虚拟机支持模块的时候自动安装的。</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ip a;                                                                                         </span></span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master br0 state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:e3:3d:4a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">3: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:e3:3d:4a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.160.172/24 brd 192.168.160.255 scope global noprefixroute br0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fee3:3d4a/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:4d:79:b9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:4d:79:b9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">6: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master br0 state UNKNOWN group default qlen 1000</span><br><span class="line">    link/ether fe:54:00:4f:3a:89 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::fc54:ff:fe4f:3a89/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="comment"># 其中virbr0是由宿主机虚拟机支持模块安装时产生的虚拟网络接口，也是一个switch和bridge，负责把内容分发到各虚拟机。几个虚拟机管理模块产生的接口关系如下图:</span></span><br><span class="line">┌───────────────────────┐                      </span><br><span class="line">│         HOST          │                      </span><br><span class="line">│ ┌──────┐              │   ┌─────────────────┐</span><br><span class="line">│ │ br0  │─┬──────┐     │   │Virtual Machine 1│</span><br><span class="line">│ └──────┘ │      │     │   │   ┌──────┐      │</span><br><span class="line">│     │    │  ┌───────┐ │ ─ │   │ br0  │      │</span><br><span class="line">│     │    │  │ vnet0 │─│┘  │   └──────┘      │</span><br><span class="line">│ ┌──────┐ │  └───────┘ │   └─────────────────┘</span><br><span class="line">│ │virbr0│ │  ┌───────┐ │   ┌─────────────────┐</span><br><span class="line">│ │ -nic │ └──│ vnet1 │─│┐  │Virtual Machine 2│</span><br><span class="line">│ └──────┘    └───────┘ │   │                 │</span><br><span class="line">│ ┌──────┐              │└ ─│   ┌──────┐      │</span><br><span class="line">│ │ eth0 │              │   │   │ br0  │      │</span><br><span class="line">│ └──────┘              │   │   └──────┘      │</span><br><span class="line">└───────────────────────┘   └─────────────────┘</span><br><span class="line"><span class="comment"># 从图上可以看出，虚拟接口和物理接口之间没有连接关系，所以虚拟机只能在通过虚拟的网络访问外部世界，无法从网络上定位和访问虚拟主机。</span></span><br><span class="line"><span class="comment"># virbr0是一个桥接器，接收所有到网络192.168.122.*的内容。从下面命令可以验证：</span></span><br><span class="line">[root@localhost ~]<span class="comment"># brctl show                                                                                    </span></span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">br0             8000.000c29e33d4a       yes             eth0</span><br><span class="line">                                                        vnet0</span><br><span class="line">virbr0          8000.5254004d79b9       yes             virbr0-nic</span><br><span class="line">[root@localhost ~]<span class="comment"># ip r                                                                                          </span></span><br><span class="line">default via 192.168.160.2 dev br0 proto static metric 425 </span><br><span class="line">192.168.122.0/24 dev virbr0 proto kernel scope link src 192.168.122.1 </span><br><span class="line">192.168.160.0/24 dev br0 proto kernel scope link src 192.168.160.172 metric 425</span><br><span class="line"><span class="comment"># 同时，虚拟机支持模块会修改iptables规则，通过命令可以查看：</span></span><br><span class="line">[root@localhost ~]<span class="comment"># iptables -t nat -L -nv</span></span><br><span class="line">[root@localhost ~]<span class="comment"># iptables -t filter -L -nv</span></span><br><span class="line"><span class="comment"># 如果没有default的话，或者需要扩展自己的虚拟网络，可以使用命令重新安装NAT。</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh net-define /usr/share/libvirt/networks/default.xml</span></span><br><span class="line"><span class="comment"># 此命令定义一个虚拟网络，default.xml的内容：</span></span><br><span class="line">&lt;network&gt;</span><br><span class="line">  &lt;name&gt;default&lt;/name&gt;</span><br><span class="line">  &lt;bridge name=<span class="string">"virbr0"</span> /&gt;</span><br><span class="line">  &lt;forward/&gt;</span><br><span class="line">  &lt;ip address=<span class="string">"192.168.122.1"</span> netmask=<span class="string">"255.255.255.0"</span>&gt;</span><br><span class="line">    &lt;dhcp&gt;</span><br><span class="line">      &lt;range start=<span class="string">"192.168.122.2"</span> end=<span class="string">"192.168.122.254"</span> /&gt;</span><br><span class="line">    &lt;/dhcp&gt;</span><br><span class="line">  &lt;/ip&gt;</span><br><span class="line">&lt;/network&gt;</span><br><span class="line"><span class="comment"># 也可以修改xml，创建自己的虚拟网络。</span></span><br><span class="line"><span class="comment"># 标记为自动启动：</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh net-autostart default</span></span><br><span class="line"><span class="comment"># Network default marked as autostarted</span></span><br><span class="line">启动网络：</span><br><span class="line">[root@localhost ~]<span class="comment"># virsh net-start default</span></span><br><span class="line"><span class="comment"># Network default started</span></span><br><span class="line"></span><br><span class="line">网络启动后可以用命令brctl show 查看和验证。</span><br><span class="line">修改vi /etc/sysctl.conf中参数，允许ip转发，CentOS7是在vi /usr/lib/sysctl.d/00-system.conf 这里面修改</span><br><span class="line"></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line">通过 sysctl -p 查看修改结果</span><br></pre></td></tr></table></figure></p>
<h6 id="自定义NAT模式"><a href="#自定义NAT模式" class="headerlink" title="自定义NAT模式"></a>自定义NAT模式</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建名为management的NAT网络，vi /usr/share/libvirt/networks/management.xml</span></span><br><span class="line">&lt;network&gt;</span><br><span class="line">  &lt;name&gt;management&lt;/name&gt;</span><br><span class="line">  &lt;bridge name=<span class="string">"virbr1"</span>/&gt;</span><br><span class="line">  &lt;forward/&gt;</span><br><span class="line">  &lt;ip address=<span class="string">"192.168.123.1"</span> netmask=<span class="string">"255.255.255.0"</span>&gt;</span><br><span class="line">    &lt;dhcp&gt;</span><br><span class="line">      &lt;range start=<span class="string">"192.168.123.2"</span> end=<span class="string">"192.168.123.254"</span>/&gt;</span><br><span class="line">    &lt;/dhcp&gt;</span><br><span class="line">  &lt;/ip&gt;</span><br><span class="line">&lt;/network&gt;</span><br><span class="line"><span class="comment"># 启用新建的NAT网络</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh net-define /usr/share/libvirt/networks/management.xml</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh net-start management</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh net-autostart management</span></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># brctl show</span></span><br><span class="line">bridge name bridge id   STP enabled interfaces</span><br><span class="line">br0   8000.3863bb44cf6c no    eno1</span><br><span class="line">							  vnet0</span><br><span class="line">virbr0    8000.525400193f0f yes   virbr0-nic</span><br><span class="line">virbr1    8000.52540027f0ba yes   virbr1-nic</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh net-list --all</span></span><br><span class="line">  Name                 State      Autostart     Persistent</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">  default              active     no            no</span><br><span class="line">  management           active     yes           yes</span><br></pre></td></tr></table></figure>
<h6 id="退出虚拟机"><a href="#退出虚拟机" class="headerlink" title="退出虚拟机"></a>退出虚拟机</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span> <span class="comment"># 退出系统到登录界面</span></span><br><span class="line">Ctrl+5 <span class="comment"># 从虚拟机登录页面，退出到宿主机命令行页面</span></span><br><span class="line">Ctrl+] <span class="comment"># 或者下面</span></span><br></pre></td></tr></table></figure>
<h6 id="修改虚拟机配置信息"><a href="#修改虚拟机配置信息" class="headerlink" title="修改虚拟机配置信息"></a>修改虚拟机配置信息</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接通过vim命令修改</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim  /etc/libvirt/qemu/centos72.xml</span></span><br><span class="line"><span class="comment"># 通过virsh命令修改</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh edit centos72</span></span><br></pre></td></tr></table></figure>
<h6 id="克隆虚拟机"><a href="#克隆虚拟机" class="headerlink" title="克隆虚拟机"></a>克隆虚拟机</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 暂停原始虚拟机</span></span><br><span class="line">virsh shutdown centos72</span><br><span class="line">[root@localhost ~]<span class="comment"># virt-clone -o centos72 -n centos.112 -f /home/vms/centos.112.qcow2 -m 00:00:00:00:00:01</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virt-clone -o centos88 -n centos.112 --file /home/vms/centos.112.qcow2 --nonsparse</span></span><br><span class="line"></span><br><span class="line">virt-clone 参数介绍</span><br><span class="line"></span><br><span class="line">    --version 查看版本。</span><br><span class="line">    -h，--<span class="built_in">help</span> 查看帮助信息。</span><br><span class="line">    --connect=URI 连接到虚拟机管理程序 libvirt 的URI。</span><br><span class="line">    -o 原始虚拟机名称 原始虚拟机名称，必须为关闭或者暂停状态。</span><br><span class="line">    -n 新虚拟机名称 –name 新虚拟机名称。</span><br><span class="line">    --auto-clone 从原来的虚拟机配置自动生成克隆名称和存储路径。</span><br><span class="line">    -u NEW_UUID, --uuid=NEW_UUID 克隆虚拟机的新的UUID，默认值是一个随机生成的UUID。</span><br><span class="line">    -m NEW_MAC, --mac=NEW_MAC 设置一个新的mac地址，默认为随机生成 MAC。</span><br><span class="line">    -f NEW_DISKFILE, --file=NEW_DISKFILE 为新客户机使用新的磁盘镜像文件地址。</span><br><span class="line">    --force-copy=TARGET 强制复制设备。</span><br><span class="line">    --nonsparse 不使用稀疏文件复制磁盘映像。</span><br></pre></td></tr></table></figure>
<h6 id="通过镜像创建虚拟机"><a href="#通过镜像创建虚拟机" class="headerlink" title="通过镜像创建虚拟机"></a>通过镜像创建虚拟机</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">---------1、创建虚拟机镜像文件--------</span><br><span class="line"><span class="comment"># 复制第一次安装的干净系统镜像，作为基础镜像文件，</span></span><br><span class="line"><span class="comment"># 后面创建虚拟机使用这个基础镜像</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cp /home/vms/centos.88.qcow2 /home/vms/centos7.base.qcow2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用基础镜像文件，创建新的虚拟机镜像</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cp /home/vms/centos7.base.qcow2 /home/vms/centos7.113.qcow2</span></span><br><span class="line"></span><br><span class="line">---------2、创建虚拟机配置文件--------</span><br><span class="line"><span class="comment"># 复制第一次安装的干净系统镜像，作为基础配置文件。</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh dumpxml centos.88 &gt; /home/vms/centos7.base.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用基础虚拟机镜像配置文件，创建新的虚拟机配置文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cp /home/vms/centos7.base.xml /home/vms/centos7.113.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑新虚拟机配置文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vi /home/vms/centos7.113.xml</span></span><br><span class="line"><span class="comment"># 主要是修改虚拟机文件名，UUID，镜像地址和网卡地址，其中 UUID 在 Linux 下可以使用 uuidgen 命令生成</span></span><br><span class="line">&lt;domain <span class="built_in">type</span>=<span class="string">'kvm'</span>&gt;</span><br><span class="line">  &lt;name&gt;centos7.113&lt;/name&gt;</span><br><span class="line">  &lt;uuid&gt;1e86167a-33a9-4ce8-929e-58013fbf9122&lt;/uuid&gt;</span><br><span class="line">  &lt;devices&gt;</span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">'file'</span> device=<span class="string">'disk'</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> file=<span class="string">'/home/vms/centos7.113.img'</span>/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;interface <span class="built_in">type</span>=<span class="string">'bridge'</span>&gt;</span><br><span class="line">      &lt;mac address=<span class="string">'00:00:00:00:00:04'</span>/&gt;</span><br><span class="line">    &lt;/interface&gt;    </span><br><span class="line">    &lt;/devices&gt;</span><br><span class="line">&lt;/domain&gt;</span><br><span class="line">[root@localhost ~]<span class="comment"># virsh define /home/vms/centos7.113.xml</span></span><br><span class="line"><span class="comment"># Domain centos.113 defined from /home/vms/centos7.113.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建磁盘</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mkdir /home/vms</span></span><br><span class="line"><span class="comment"># 创建 guest 所需的磁盘</span></span><br><span class="line"><span class="comment"># create 表示创建，-f qcow2 表示创建一个格式为 qcow2 的磁盘， </span></span><br><span class="line"><span class="comment"># /home/vms/centos78.qcow2 表示创建的磁盘名称及磁盘文件，40G 表示该磁盘可用大小。</span></span><br><span class="line">[root@localhost ~]<span class="comment"># qemu-img create -f qcow2 -o preallocation=metadata /home/vms/centos78.qcow2 40G</span></span><br></pre></td></tr></table></figure>
<h6 id="常用命令说明"><a href="#常用命令说明" class="headerlink" title="常用命令说明"></a>常用命令说明</h6><p><strong>virt-install</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 常用参数说明</span></span><br><span class="line">–name指定虚拟机名称</span><br><span class="line">–memory分配内存大小。</span><br><span class="line">–vcpus分配CPU核心数，最大与实体机CPU核心数相同</span><br><span class="line">–disk指定虚拟机镜像，size指定分配大小单位为G。</span><br><span class="line">–network网络类型，此处用的是默认，一般用的应该是bridge桥接。</span><br><span class="line">–accelerate加速</span><br><span class="line">–cdrom指定安装镜像iso</span><br><span class="line">–vnc启用VNC远程管理，一般安装系统都要启用。</span><br><span class="line">–vncport指定VNC监控端口，默认端口为5900，端口不能重复。</span><br><span class="line">–vnclisten指定VNC绑定IP，默认绑定127.0.0.1，这里改为0.0.0.0。</span><br><span class="line">–os-type=linux,windows</span><br><span class="line">–os-variant=rhel6</span><br><span class="line"></span><br><span class="line">--name      指定虚拟机名称</span><br><span class="line">--ram       虚拟机内存大小，以 MB 为单位</span><br><span class="line">--vcpus     分配CPU核心数，最大与实体机CPU核心数相同</span><br><span class="line">–-vnc       启用VNC远程管理，一般安装系统都要启用。</span><br><span class="line">–-vncport   指定VNC监控端口，默认端口为5900，端口不能重复。</span><br><span class="line">–-vnclisten  指定VNC绑定IP，默认绑定127.0.0.1，这里改为0.0.0.0。</span><br><span class="line">--network   虚拟机网络配置</span><br><span class="line">  <span class="comment"># 其中子选项，bridge=br0 指定桥接网卡的名称。</span></span><br><span class="line"></span><br><span class="line">–os-type=linux,windows</span><br><span class="line">–os-variant=rhel7.2</span><br><span class="line"></span><br><span class="line">--disk 指定虚拟机的磁盘存储位置</span><br><span class="line">  <span class="comment"># size，初始磁盘大小，以 GB 为单位。</span></span><br><span class="line"></span><br><span class="line">--location 指定安装介质路径，如光盘镜像的文件路径。</span><br><span class="line">--graphics 图形化显示配置</span><br><span class="line">  <span class="comment"># 全新安装虚拟机过程中可能会有很多交互操作，比如设置语言，初始化 root 密码等等。</span></span><br><span class="line">  <span class="comment"># graphics 选项的作用就是配置图形化的交互方式，可以使用 vnc（一种远程桌面软件）进行链接。</span></span><br><span class="line">  <span class="comment"># 我们这列使用命令行的方式安装，所以这里要设置为 none，但要通过 --extra-args 选项指定终端信息，</span></span><br><span class="line">  <span class="comment"># 这样才能将安装过程中的交互信息输出到当前控制台。</span></span><br><span class="line">--extra-args 根据不同的安装方式设置不同的额外选项</span><br></pre></td></tr></table></figure></p>
<p><strong>virsh</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">virsh list                 <span class="comment"># 查看在运行的虚拟机</span></span><br><span class="line">virsh dumpxml vm-name      <span class="comment"># 查看kvm虚拟机配置文件</span></span><br><span class="line">virsh start vm-name        <span class="comment"># 启动kvm虚拟机</span></span><br><span class="line">virsh shutdown vm-name     <span class="comment"># 正常关机</span></span><br><span class="line"></span><br><span class="line">virsh destroy vm-name      <span class="comment"># 非正常关机，强制关闭虚拟机（相当于物理机直接拔掉电源）</span></span><br><span class="line">virsh undefine vm-name     <span class="comment"># 删除vm的配置文件</span></span><br><span class="line"></span><br><span class="line">ls  /etc/libvirt/qemu</span><br><span class="line"><span class="comment"># 查看删除结果，Centos-6.6的配置文件被删除，但磁盘文件不会被删除</span></span><br><span class="line"></span><br><span class="line">virsh define file-name.xml <span class="comment"># 根据配置文件定义虚拟机</span></span><br><span class="line">virsh <span class="built_in">suspend</span> vm-name      <span class="comment"># 挂起，终止</span></span><br><span class="line">virsh resumed vm-name      <span class="comment"># 恢复被挂起的虚拟机</span></span><br><span class="line">virsh autostart vm-name    <span class="comment"># 开机自启动vm</span></span><br><span class="line">virsh console &lt;虚拟机名称&gt;   <span class="comment"># 连接虚拟机</span></span><br></pre></td></tr></table></figure></p>
<p><strong>错误解决</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">console <span class="built_in">test</span></span><br><span class="line">Connected to domain <span class="built_in">test</span></span><br><span class="line">Escape character is ^]</span><br><span class="line"><span class="comment"># 如果出现上面字符串使用 CTRL+Shift+5 CTRL+Shift+]</span></span><br></pre></td></tr></table></figure></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-11-12</span><i class="fa fa-tag"></i><a class="tag" href="/tags/kvm/" title="kvm">kvm </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,skyisfuck.github.io/2018/11/12/centos7-kvm/,big head,centos7_kvm,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/11/09/Centos7安装Xen/" title="Centos7安装Xen">下一篇</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js?v=undefined"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false, 
  verify:false|| false, 
  app_id:'uILvmzOCbHtRJCgWCCEoWNPx-gzGzoHsz',
  app_key:'r7WD847PyX9xg8ldEEHnr4o8',
  placeholder:'Today is good day!!!',
  path: window.location.pathname,
  avatar:'monsterid'
})</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/love.js"></script></body></html>