<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="big head,306647809@qq.com"><title>nginx_location_module · big head</title><meta name="description" content="原文：https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx/nginx_local_pcre.html语法规则
  location [=|~|~*|^~] /uri/ { … }


五种匹配方式12345=	开"><meta name="keywords" content="Hexo,HTML,CSS,android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">big head</a></h3><div class="description"><p>随便写写</p></div></div></div><ul class="social-links"><li><a href="http://weibo.com/inoroorg"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/skyisfuck"><i class="fa fa-github"></i></a></li></ul><!--.footer--><!--  a(target="_blank", href="/")--><!--    span Theme by --><!--  a(href="skyisfuck.github.io")  skyisfuck--><!--  span &--><!--  a(href="https://github.com/Ben02/hexo-theme-Anatole")  Ben--><!--  .by_farbox--><!--    a(href="skyisfuck", target="_blank") Proudly published with Hexo&#65281;--><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><center><div class="powered-by"><i class="fa fa-user"></i><span id="busuanzi_container_site_uv">&nbsp; <span id="busuanzi_value_site_uv"></span>&nbsp;  &nbsp;   </span><i class="fa fa-eye"></i><span id="busuanzi_container_site_pv">&nbsp; <span id="busuanzi_value_site_pv"></span></span></div></center></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li><li><a href="/games">小游戏</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>nginx_location_module</a></h3></div><div class="post-content"><h3 id="原文：https-moonbingbing-gitbooks-io-openresty-best-practices-content-ngx-nginx-local-pcre-html"><a href="#原文：https-moonbingbing-gitbooks-io-openresty-best-practices-content-ngx-nginx-local-pcre-html" class="headerlink" title="原文：https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx/nginx_local_pcre.html"></a>原文：<a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx/nginx_local_pcre.html" target="_blank" rel="noopener">https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx/nginx_local_pcre.html</a></h3><h4 id="语法规则"><a href="#语法规则" class="headerlink" title="语法规则"></a>语法规则</h4><blockquote>
<font color="green">  location [=|~|~*|^~] /uri/ { … }</font>

</blockquote>
<h4 id="五种匹配方式"><a href="#五种匹配方式" class="headerlink" title="五种匹配方式"></a>五种匹配方式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=	开头表示精确匹配</span><br><span class="line">^~	开头表示 uri 以某个常规字符串开头，理解为匹配 url 路径即可。nginx 不对 url 做编码，因此请求为/static/20%/aa，可以被规则^~ /static/ /aa匹配到（注意是空格）</span><br><span class="line">~	开头表示区分大小写的正则匹配</span><br><span class="line">~*	开头表示不区分大小写的正则匹配</span><br><span class="line">/	通用匹配，任何请求都会匹配到</span><br></pre></td></tr></table></figure>
<p>多个 location 配置的情况下匹配顺序为（参考资料而来，还未实际验证，试试就知道了，不必拘泥，仅供参考）:</p>
<ul>
<li>首先匹配 =</li>
<li>其次匹配 ^~</li>
<li>其次是按文件中顺序的正则匹配</li>
<li>最后是交给 / 通用匹配</li>
<li>当有匹配成功时候，停止匹配，按当前匹配规则处理请求<br>例子，有如下匹配规则：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;</span><br><span class="line">   #规则A</span><br><span class="line">&#125;</span><br><span class="line">location = /login &#123;</span><br><span class="line">   #规则B</span><br><span class="line">&#125;</span><br><span class="line">location ^~ /static/ &#123;</span><br><span class="line">   #规则C</span><br><span class="line">&#125;</span><br><span class="line">location ~ \.(gif|jpg|png|js|css)$ &#123;</span><br><span class="line">   #规则D</span><br><span class="line">&#125;</span><br><span class="line">location ~* \.png$ &#123;</span><br><span class="line">   #规则E</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">   #规则F</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么产生的效果如下：</p>
<ul>
<li>访问根目录 /， 比如 <code>http://localhost/</code> 将匹配规则 A</li>
<li>访问 <code>http://localhost/login</code> 将匹配规则 B，<code>http://localhost/register</code> 则匹配规则 F</li>
<li>访问 <code>http://localhost/static/a.html</code> 将匹配规则 C</li>
<li>访问 <code>http://localhost/a.gif, http://localhost/b.jpg</code> 将匹配规则 D 和规则 E，但是规则 D 顺序优先，规则 E 不起作用，而 <code>http://localhost/static/c.png</code> 则优先匹配到规则 C访问 <code>http://localhost/a.PNG</code> 则匹配规则 E，而不会匹配规则 D，因为规则 E 不区分大小写。</li>
<li>访问 <code>http://localhost/category/id/1111</code> 则最终匹配到规则 F，因为以上规则都不匹配，这个时候应该是 nginx 转发请求给后端应用服务器，比如 FastCGI（php），tomcat（jsp），nginx 作为反向代理服务器存在。<br>所以实际使用中，笔者觉得至少有三个匹配规则定义，如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 直接匹配网站根，通过域名访问网站首页比较频繁，使用这个会加速处理，官网如是说。</span><br><span class="line"># 这里是直接转发给后端应用服务器了，也可以是一个静态首页</span><br><span class="line"># 第一个必选规则</span><br><span class="line">location = / &#123;</span><br><span class="line">    proxy_pass http://tomcat:8080/index</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 第二个必选规则是处理静态文件请求，这是 nginx 作为 http 服务器的强项</span><br><span class="line"># 有两种配置模式，目录匹配或后缀匹配，任选其一或搭配使用</span><br><span class="line">location ^~ /static/ &#123;</span><br><span class="line">    root /webroot/static/;</span><br><span class="line">&#125;</span><br><span class="line">location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ &#123;</span><br><span class="line">    root /webroot/res/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 第三个规则就是通用规则，用来转发动态请求到后端应用服务器</span><br><span class="line"># 非静态文件请求就默认是动态请求，自己根据实际把握</span><br><span class="line"># 毕竟目前的一些框架的流行，带.php、.jsp后缀的情况很少了</span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://tomcat:8080/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ReWrite语法"><a href="#ReWrite语法" class="headerlink" title="ReWrite语法"></a>ReWrite语法</h3><ul>
<li>last – 基本上都用这个 Flag</li>
<li>break – 中止 Rewirte，不再继续匹配</li>
<li>redirect – 返回临时重定向的 HTTP 状态 302</li>
<li>permanent – 返回永久重定向的 HTTP 状态 301</li>
</ul>
<p>1、下面是可以用来判断的表达式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-f 和 !-f 用来判断是否存在文件</span><br><span class="line">-d 和 !-d 用来判断是否存在目录</span><br><span class="line">-e 和 !-e 用来判断是否存在文件或目录</span><br><span class="line">-x 和 !-x 用来判断文件是否可执行</span><br></pre></td></tr></table></figure></p>
<p>2、下面是可以用作判断的全局变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">例：http://localhost:88/test1/test2/test.php?k=v</span><br><span class="line">$host：localhost</span><br><span class="line">$server_port：88</span><br><span class="line">$request_uri：/test1/test2/test.php?k=v</span><br><span class="line">$document_uri：/test1/test2/test.php</span><br><span class="line">$document_root：D:\nginx/html</span><br><span class="line">$request_filename：D:\nginx/html/test1/test2/test.ph</span><br></pre></td></tr></table></figure></p>
<h3 id="Redirect-语法"><a href="#Redirect-语法" class="headerlink" title="Redirect 语法"></a>Redirect 语法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name start.igrow.cn;</span><br><span class="line">    index index.html index.php;</span><br><span class="line">    root html;</span><br><span class="line">    if ($http_host !~ &quot;^star\.igrow\.cn$&quot;) &#123;</span><br><span class="line">        rewrite ^(.*) http://star.igrow.cn$1 redirect;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="防盗链"><a href="#防盗链" class="headerlink" title="防盗链"></a>防盗链</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(gif|jpg|swf)$ &#123;</span><br><span class="line">    valid_referers none blocked start.igrow.cn sta.igrow.cn;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">       rewrite ^/ http://$host/logo.png;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="根据文件类型设置过期时间"><a href="#根据文件类型设置过期时间" class="headerlink" title="根据文件类型设置过期时间"></a>根据文件类型设置过期时间</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(js|css|jpg|jpeg|gif|png|swf)$ &#123;</span><br><span class="line">    if (-f $request_filename) &#123;</span><br><span class="line">        expires 1h;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="禁止访问某个目录"><a href="#禁止访问某个目录" class="headerlink" title="禁止访问某个目录"></a>禁止访问某个目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(txt|doc)$&#123;</span><br><span class="line">    root /data/www/wwwroot/linuxtone/test;</span><br><span class="line">    deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="显示客户端真实ip"><a href="#显示客户端真实ip" class="headerlink" title="显示客户端真实ip"></a>显示客户端真实ip</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nginx的配置</span><br><span class="line">location \ &#123;</span><br><span class="line">    proxy_set_header   X-Real-IP  $remote_addr;</span><br><span class="line">    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for; </span><br><span class="line">&#125;</span><br><span class="line">X-Forwarded-For和X-Real-IP的区别是，如果请求时已带了X-Forwarded-For，则nginx追加方式，这样可以通过它显示转发的轨迹。</span><br><span class="line">当然请求时完全可以构造假的X-Forwarded-For，在配置文件打开了X-Real-IP及编译指定了--with-http_realip_module时，环境变量HTTP_X_REAL_IP总是为真实的客户端IP。</span><br><span class="line">后端server配置</span><br><span class="line">httpd </span><br><span class="line">LogFormat &quot;%h %l %u %t /&quot;%r/&quot; %&gt;s %b /&quot;%&#123;Referer&#125;i/&quot; /&quot;%&#123;User-Agent&#125;i/&quot;&quot; combined</span><br><span class="line">把其中的%h 换成 %&#123;X-Real-IP&#125;i</span><br></pre></td></tr></table></figure>
<h3 id="proxy-cache-path"><a href="#proxy-cache-path" class="headerlink" title="proxy_cache_path"></a>proxy_cache_path</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    ......</span><br><span class="line">    proxy_cache_path /data/nginx/tmp-test levels=1:2 keys_zone=tmp-test:100m inactive=7d max_size=1000g;</span><br><span class="line"># 代码说明：</span><br><span class="line"># proxy_cache_path 缓存文件路径</span><br><span class="line"># levels 设置缓存文件目录层次；levels=1:2  表示两级目录</span><br><span class="line"># keys_zone 设置缓存名字和共享内存大小</span><br><span class="line"># inactive 在指定时间内没人访问则被删除</span><br><span class="line"># max_size 最大缓存空间，如果缓存空间满，默认覆盖掉缓存时间最长的资源。</span><br><span class="line"># 当配置好之后，重启nginx，如果不报错，则配置的proxy_cache会生效</span><br><span class="line"># 查看proxy_cache_path /data/nginx/目录，会发现生成了tmp-test文件夹。</span><br><span class="line"></span><br><span class="line">    location /tmp-test/ &#123;  </span><br><span class="line">	proxy_cache tmp-test; # 使用名为tmp-test的对应缓存配置</span><br><span class="line">  	proxy_cache_valid  200 206 304 301 302 10d; # 对httpcode为200…的缓存10天 </span><br><span class="line">	proxy_cache_key $uri; # 定义缓存唯一key,通过唯一key来进行hash存取</span><br><span class="line">#	add_header X-Cache &quot;$upstream_cache_status from $server_ip&quot; # 可以添加一个首部，在客户端可以看见缓存是否命中</span><br><span class="line">	proxy_set_header Host $host:$server_port; # 自定义http header头，用于发送给后端真实服务器。 </span><br><span class="line">	proxy_set_header X-Real-IP $remote_addr;   </span><br><span class="line">	proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;  </span><br><span class="line">	proxy_pass http://127.0.0.1:8081/media_store.php/tmp-test/; # 指代理后转发的路径，注意是否需要最后的/</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-10-05</span><i class="fa fa-tag"></i><a class="tag" href="/tags/nginx/" title="nginx">nginx </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,skyisfuck.github.io/2018/10/05/nginx_location_module/,big head,nginx_location_module,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/09/11/Centos7-自动登录/" title="Centos7-自动登录">下一篇</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js?v=undefined"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false, 
  verify:false|| false, 
  app_id:'uILvmzOCbHtRJCgWCCEoWNPx-gzGzoHsz',
  app_key:'r7WD847PyX9xg8ldEEHnr4o8',
  placeholder:'Today is good day!!!',
  path: window.location.pathname,
  avatar:'monsterid'
})</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/love.js"></script></body></html>